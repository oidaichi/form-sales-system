<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ ãƒ•ã‚©ãƒ¼ãƒ å–¶æ¥­ã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #ffffff; /* ç™½èƒŒæ™¯ */
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 8px;
            padding: 20px;
        }
        h1, h2 {
            color: #1A237E; /* è—è‰² */
            border-bottom: 2px solid #E8EAF6; /* è–„ã„è—è‰² */
            padding-bottom: 10px;
            margin-bottom: 25px;
        }
        .card {
            border: 1px solid #C5CAE9; /* è–„ã„è—è‰² */
            border-radius: 8px;
            margin-bottom: 25px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        .progress-bar {
            background-color: #2962FF; /* é’è‰² */
        }
        .stat-box {
            text-align: center;
            padding: 20px;
            background-color: #F1F3F5;
            border-radius: 8px;
            margin: 5px;
            flex: 1;
            min-width: 130px;
        }
        .stat-box h4 {
            color: #1A237E; /* è—è‰² */
            font-size: 2em;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .btn-primary, .btn-primary:hover, .btn-primary:active, .btn-primary:visited {
            background-color: #1A237E !important; /* è—è‰² */
            border-color: #1A237E !important;
        }
        .btn-success, .btn-success:hover, .btn-success:active, .btn-success:visited {
            background-color: #2962FF !important; /* é’è‰² */
            border-color: #2962FF !important;
        }
        .table thead th {
            background-color: #E8EAF6; /* è–„ã„è—è‰² */
            color: #1A237E; /* è—è‰² */
            position: sticky;
            top: 0;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">ğŸš€ ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ ãƒ•ã‚©ãƒ¼ãƒ å–¶æ¥­ã‚·ã‚¹ãƒ†ãƒ </h1>

        <div class="card">
            <h2>ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            <div class="form-group">
                <label for="csvFile" class="btn btn-outline-primary">ğŸ“Š CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</label>
                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                <span id="fileName" class="ml-3 text-muted">ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</span>
            </div>
            <button class="btn btn-primary" onclick="uploadCsv()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        </div>

        <div class="card">
            <h2>ğŸ“Š å‡¦ç†çµ±è¨ˆ</h2>
            <div class="d-flex justify-content-around flex-wrap">
                <div class="stat-box">
                    <h4><span id="totalCompanies">0</span></h4>
                    <p>ç·ä¼æ¥­æ•°</p>
                </div>
                <div class="stat-box">
                    <h4><span id="unprocessedCompanies">0</span></h4>
                    <p>æœªå‡¦ç†ä¼æ¥­</p>
                </div>
                <div class="stat-box">
                    <h4><span id="nextBatchCount">0</span></h4>
                    <p>æ¬¡å›å‡¦ç†æ•°</p>
                </div>
                <div class="stat-box">
                    <h4><span id="successRate">0.00</span>%</h4>
                    <p>æˆåŠŸç‡</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>âš¡ å‡¦ç†å®Ÿè¡Œ</h2>
            <div class="btn-group mb-3" role="group">
                <button class="btn btn-success" onclick="startProcessing()">ğŸ¤– ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹å‡¦ç†é–‹å§‹</button>
                <button class="btn btn-info" disabled>ğŸ–¥ï¸ ã‚¿ãƒ–ãƒ™ãƒ¼ã‚¹å‡¦ç†é–‹å§‹ (æœªå®Ÿè£…)</button>
                <button class="btn btn-danger" disabled>â¹ï¸ åœæ­¢ (æœªå®Ÿè£…)</button>
            </div>
            <div class="progress mb-2">
                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progressBar">0%</div>
            </div>
            <p>ç¾åœ¨å‡¦ç†ä¸­: <span id="currentProcessingCompany">å¾…æ©Ÿä¸­</span> (<span id="processedCount">0</span>/<span id="totalProcessed">0</span>)</p>
        </div>

        <div class="card">
            <h2>ğŸ‘€ ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ä¼æ¥­å</th>
                            <th>URL</th>
                            <th>å‡¦ç†çŠ¶æ³</th>
                        </tr>
                    </thead>
                    <tbody id="csvPreviewTableBody">
                        <!-- CSVãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
                document.getElementById('csvFile').addEventListener('change', function() {
            var fileName = this.files[0] ? this.files[0].name : 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“';
            document.getElementById('fileName').textContent = fileName;
        });

        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('processing_start', function(data) {
            totalCompanies = data.total_companies;
            processedCompanies = 0;
            successfulCompanies = 0;
            document.getElementById('totalCompanies').textContent = totalCompanies;
            document.getElementById('unprocessedCompanies').textContent = totalCompanies;
            document.getElementById('nextBatchCount').textContent = Math.min(30, totalCompanies);
            document.getElementById('successRate').textContent = '0.00';
            document.getElementById('currentProcessingCompany').textContent = 'å‡¦ç†é–‹å§‹...';
            document.getElementById('processedCount').textContent = '0';
            document.getElementById('totalProcessed').textContent = totalCompanies;
            updateProgressBar(0);
        });

        socket.on('processing_status', function(msg) {
            console.log(msg.message);
        });

        socket.on('processing_progress', function(msg) {
            processedCompanies = msg.processed_count;
            document.getElementById('currentProcessingCompany').textContent = msg.current_company;
            document.getElementById('processedCount').textContent = processedCompanies;
            document.getElementById('totalProcessed').textContent = totalCompanies;
            document.getElementById('unprocessedCompanies').textContent = totalCompanies - processedCompanies;

            if (msg.status === 'success') {
                successfulCompanies++;
            }
            let rate = (successfulCompanies / processedCompanies * 100).toFixed(2);
            if (isNaN(rate)) rate = '0.00';
            document.getElementById('successRate').textContent = rate;

            updateProgressBar(msg.progress);
            renderPreviewTable(msg.current_index); // Re-render preview centered on current index
        });

        socket.on('processing_complete', function(msg) {
            document.getElementById('currentProcessingCompany').textContent = msg.message;
            updateProgressBar(100);
            alert(msg.message);
            renderPreviewTable(-1); // Re-render to show final status
        });

        function updateProgressBar(progress) {
            var progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressBar.textContent = progress + '%';
        }

        function uploadCsv() {
            var fileInput = document.getElementById('csvFile');
            var file = fileInput.files[0];
            if (!file) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            var formData = new FormData();
            formData.append('file', file);

            // Reset UI state
            document.getElementById('currentProcessingCompany').textContent = 'å¾…æ©Ÿä¸­';
            updateProgressBar(0);

            fetch('/upload_csv', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    allCsvData = [];
                    totalCompanies = 0;
                } else {
                    alert(data.message);
                    totalCompanies = data.total_companies;
                    allCsvData = data.processed_csv_data;

                    document.getElementById('totalCompanies').textContent = totalCompanies;
                    document.getElementById('unprocessedCompanies').textContent = totalCompanies;
                    document.getElementById('nextBatchCount').textContent = Math.min(30, totalCompanies);
                    document.getElementById('successRate').textContent = '0.00';
                    document.getElementById('processedCount').textContent = '0';
                    document.getElementById('totalProcessed').textContent = totalCompanies;

                    renderPreviewTable(0); // Render initial preview
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during file upload.');
            });
        }

        function renderPreviewTable(currentIndex) {
            var tableBody = document.getElementById('csvPreviewTableBody');
            tableBody.innerHTML = '';

            if (!allCsvData || allCsvData.length === 0) {
                return;
            }

            let start = 0;
            let end = allCsvData.length;

            if (currentIndex !== -1) {
                start = Math.max(0, currentIndex - 10);
                end = Math.min(allCsvData.length, currentIndex + 10);
            }

            const dataToShow = allCsvData.slice(start, end);

            dataToShow.forEach((row, index) => {
                const originalIndex = start + index;
                var newRow = tableBody.insertRow();
                newRow.id = 'row-' + originalIndex;

                newRow.insertCell().textContent = row.company;
                newRow.insertCell().textContent = row.url;
                
                let statusCell = newRow.insertCell();
                statusCell.textContent = 'æœªå‡¦ç†';

                if (originalIndex === currentIndex) {
                    newRow.style.backgroundColor = '#E3F2FD';
                    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }

        function startProcessing() {
            if (!allCsvData || allCsvData.length === 0) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            socket.emit('start_processing', { 'csv_data': allCsvData });
        }
    </script>
</body>
</html>