# フォーム営業AIエージェントシステム

企業ホームページから自動的に問合せフォームを検出し、営業メールを自動送信するAIエージェントシステムです。

## 📋 機能概要

### コア機能
- **Excelファイル処理**: 企業リストの読み込み・重複チェック・列構成管理
- **Webクローラー**: ホームページ巡回・問合せフォーム自動検出
- **フォーム自動入力**: 企業情報の自動入力・送信
- **HTMLメール送信**: ChatGPT APIによる企業別メール生成・送信
- **CAPTCHA対応**: reCAPTCHA・数学問題等の自動/手動対応
- **ログ管理**: 全処理ログの記録・分析・出力
- **ステップメール**: 多段階フォローアップメール機能

### 技術的特徴
- **フレームワーク**: Flask (Web UI)
- **クローリング**: Selenium + BeautifulSoup
- **データベース**: SQLite
- **AI連携**: OpenAI ChatGPT API
- **メール送信**: SMTP (Gmail)

## 🚀 セットアップ

### 1. 必要な環境
- Ubuntu (推奨)
- Python 3.10+
- Google Chrome
- Conda環境

### 2. 依存関係のインストール
```bash
# Conda環境の活性化
conda activate base

# 必要なパッケージのインストール
pip install flask flask-socketio pandas openpyxl selenium beautifulsoup4 requests openai webdriver-manager
```

### 3. 環境変数の設定
```bash
# OpenAI API Key (メール生成用)
export OPENAI_API_KEY="your-openai-api-key"

# Gmail App Password (メール送信用)
export GMAIL_APP_PASSWORD="your-gmail-app-password"
```

### 4. システムの起動
```bash
# システム起動スクリプトを実行
python start_system.py

# または直接起動
python app.py
```

## 💻 使用方法

### 1. Web UIへのアクセス
ブラウザで `http://localhost:5000` にアクセス

### 2. Excelファイルのアップロード
- 企業情報を含むExcelファイルを選択
- 対象シートを選択

### 3. 列のマッピング設定
- ホームページURL列を指定
- 企業名列を指定
- 1日の送信制限数を設定

### 4. 処理の開始
- 「処理開始」ボタンをクリック
- リアルタイムで進捗状況を確認

## 📊 処理フロー

```
Excelファイル → 企業URL抽出 → Webクローラー → フォーム検出 
→ 自動入力 → HTMLメール送信 → ログ記録 → 結果出力
```

### 詳細ステップ
1. **URL検証**: 企業URLの正規化・重複チェック
2. **フォーム検索**: 問合せフォームの自動検出
3. **フォーム入力**: 企業情報の自動入力・送信
4. **代替手段**: フォーム未検出時のメールアドレス抽出
5. **メール送信**: ChatGPT生成のHTMLメール送信
6. **ログ記録**: 全処理結果の詳細記録

## 🎛️ システム設定

### 企業情報設定
企業情報は `form_sales_system.py` 内の `TabBasedFormProcessor.prepare_input_data()` メソッドで設定されています。

### 送信制限
- デフォルト: 1日5件
- ユーザー設定可能: 1〜1000件

## 🔧 CAPTCHA対応

### 自動対応
- **reCAPTCHA v3**: 自動実行
- **数学問題**: 自動計算・回答
- **簡単な画像認証**: 2captcha API連携（要設定）

### 手動対応
- **reCAPTCHA v2**: 手動解決待機
- **複雑な画像認証**: 手動解決待機
- **hCaptcha**: 手動解決待機

## 📈 ログ・分析機能

### ログ種別
- **アクティビティログ**: 全処理活動の記録
- **エラーログ**: エラー詳細・スタックトレース
- **パフォーマンスログ**: 処理時間・効率分析
- **メール送信ログ**: 送信結果・開封率

### 出力形式
- **リアルタイム表示**: Web UI上での即時確認
- **Excel出力**: 分析用データの一括出力
- **CSV出力**: 外部システム連携用

## 🔒 セキュリティ・法的遵守

### セキュリティ対策
- 個人情報の適切な管理
- SQLiteデータベースによるローカル保存
- 送信制限による悪用防止

### 法的遵守
- **特定電子メール法**: 配信停止要請への対応
- **個人情報保護法**: 企業情報の適切な取り扱い
- **配信停止機能**: ユーザー要請への迅速対応

## 📊 成功指標

### 定量指標
- **フォーム検出成功率**: 80%以上
- **メール送信成功率**: 95%以上  
- **処理時間**: 1社あたり平均30秒以内

### パフォーマンス
- **処理能力**: 100〜1000社/回
- **メモリ使用量**: 最適化済み
- **エラーハンドリング**: 堅牢な例外処理

## 🛠️ トラブルシューティング

### よくある問題

#### 1. ChromeDriverエラー
```bash
# ChromeDriverの再インストール
python -c "from webdriver_manager.chrome import ChromeDriverManager; ChromeDriverManager().install()"
```

#### 2. メール送信エラー
- Gmail App Passwordの設定確認
- 2段階認証の有効化確認

#### 3. フォーム検出失敗
- JavaScript動的サイトの対応
- Selenium待機時間の調整

#### 4. CAPTCHA対応
- 手動解決の待機
- 2captcha API設定（オプション）

### ログ確認
```bash
# システムログの確認
tail -f logs/form_sales.log

# データベース内容の確認
sqlite3 form_sales.db ".tables"
```

## 🔄 今後の拡張予定

### 機能拡張
- 多言語対応（海外企業対応）
- AI精度向上によるフォーム検出率向上
- より多くのCRM/MAツールへの対応

### 技術拡張
- クラウド環境への移行対応
- 複数ユーザー対応
- API化による他システムとの連携

## 📞 サポート

システムに関する問い合わせや改善提案は、開発チームまでご連絡ください。

---

**⚠️ 重要**: 本システムは営業効率化を目的としており、適切な法的ガイドラインに従ってご利用ください。スパム行為や迷惑メール送信には使用しないでください。

---

## プロジェクト構造の分析メモ

このプロジェクトの構造と主要なコンポーネントに関する分析結果です。

### 1. 主要ファイルと実行フロー
- **エントリーポイント**: `app.py` がWebアプリケーションの本体であり、システムの中核です。
- **起動方法**: `start_system.py` を実行することで、仮想環境を有効化し `app.py` を起動するのが正規のフローです。
- **設定**: `config.py` で各種設定が行われます。データベース接続先は `form_sales_simple.db` です。
- **依存関係**: `requirements.txt` に記載のライブラリは、`README_システム概要.md`の記述と一致しており、適切に管理されています。

### 2. その他のファイルについて
プロジェクト内には、現在のメインシステムとは直接関連が薄い、あるいは冗長と思われるファイルが存在します。これらは今後の開発や特定のデプロイ環境で必要になる可能性を考慮し、現状のまま保持します。

- **`form_sales_system.py`**: `app.py` とは異なる実装を持つ、CUIベースのスクリプト。旧バージョンやプロトタイプの可能性があります。
- **`app-backup.py`**: `app.py` の手動バックアップ。
- **`build/`, `dist/`, `app.spec`**: PyInstallerによる実行ファイル生成時の関連ファイル。
- **`:Zone.Identifier` が末尾につくファイル**: Windows環境でダウンロードした際に自動生成されるメタデータ。
- **`Procfile`, `runtime.txt`**: Heroku環境へのデプロイ設定ファイル。
